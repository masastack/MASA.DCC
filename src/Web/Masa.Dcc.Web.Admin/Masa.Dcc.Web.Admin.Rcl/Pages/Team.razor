@page "/team/{TeamId}"
@inherits MasaCompontentBase;
@inject MasaBlazor MasaBlazor

<CascadingValue Value="this">
    <MTabs ValueChanged="TabValueChangedAsync" Value="_curTab" SliderColor="transparent" class="pro-nav remover-ripple">
        <MTab class="text-capitalize pa-0">
            <ChildContent>
                <span class="mtab-tab-line mtab-tab-linear-primary"></span>
                <span class="rounded-circle mtab-tab-indicator mtab-tab-indicator-primary"></span>
                <span class="mtab-tab-title">@T("Project")</span>
            </ChildContent>
        </MTab>
        <MTab class="text-capitalize pa-0" Disabled="_teamDetailDisabled">
            <ChildContent>
                <span class="mtab-tab-line @(_curTab.ToInt32()>0?"mtab-tab-linear-primary":"mtab-tab-linear-neutral")"></span>
                <span class="rounded-circle mtab-tab-indicator @(_curTab.ToInt32()>0?"mtab-tab-indicator-primary":"mtab-tab-indicator-neutral")"></span>
                <span class="mtab-tab-title">@T("Project detail")</span>
            </ChildContent>
        </MTab>
        <MTab class="text-capitalize pa-0" Disabled="_configDisabled">
            <ChildContent>
                <span class="mtab-tab-line @(_curTab.ToInt32()>1?"mtab-tab-linear-primary":"mtab-tab-linear-neutral")"></span>
                <span class="rounded-circle mtab-tab-indicator @(_curTab.ToInt32()>1?"mtab-tab-indicator-primary":"mtab-tab-indicator-neutral")"></span>
                <span class="mtab-tab-title">@T("Config detail")</span>
            </ChildContent>
        </MTab>
    </MTabs>

    <MTabsItems Style="background-color: transparent !important;" Value="_curTab" class="pt-6">
        <MTabItem>
            <div class="d-flex">
                <div class="pr-6" style="width: calc(100% - 300px); display:block;">
                    <div style="overflow: hidden;">
                        <div class="d-flex mb-3">
                            <MTextField @bind-Value="_projectName" OnKeyDown="SearchProject" Class="rounded-2" Height="40" Flat Dense Solo HideDetails="@("auto")" Placeholder="@T("Please enter the project name and press enter to query")">
                                <PrependInnerContent>
                                    <MIcon Size=16 Class="mr-2 neutral-lighten-1--text">mdi-magnify</MIcon>
                                </PrependInnerContent>
                            </MTextField>
                        </div>
                        <div class="mt-3" style="height: calc(100vh - 244px); overflow:auto;">
                            <MExpansionPanels Flat Accordion>
                                @foreach (var project in _projects)
                                {
                                    var apps = _apps.Where(app => app.ProjectId == project.Id).ToList();
                                    <MExpansionPanel Class="rounded-5 my-3">
                                        <MExpansionPanelHeader Style="height: 56px;" Class="my-6">
                                            <ChildContent>
                                                <span style="display:flex;align-items:center; margin-right:10px;">
                                                    <div class="emphasis--text h6">
                                                        <MHover Context="hoverContext">
                                                            <span @onclick:stopPropagation @onclick="()=>NavigateToAppAsync(project.Id)" @attributes="hoverContext.Attrs" class="@(hoverContext.Hover ? "primary--text":"")">
                                                                @project.Name
                                                            </span>
                                                        </MHover>
                                                        <div class="mt-1 regular3--text btn d-flex" style="padding:0">
                                                            @{
                                                                string backgroundColor;
                                                                switch (project.LabelCode.ToLower())
                                                                {
                                                                    case "basicability":
                                                                        backgroundColor = "#37D7AD";
                                                                        break;
                                                                    case "operator":
                                                                        backgroundColor = "#FFB547";
                                                                        break;
                                                                    case "datafactory":
                                                                        backgroundColor = "#5FB9FF";
                                                                        break;
                                                                    default:
                                                                        backgroundColor = "#BDBDBD";
                                                                        break;
                                                                }
                                                            }
                                                            <div class="d-flex justify-center mr-2" style="border-radius:6px; color:#fff; background-color:@backgroundColor; padding:0 4px;">
                                                                @project.LabelName
                                                            </div>
                                                            <span class="regular3--text body2">@project.Identity</span>
                                                            <span class="ml-2 regular3--text body2">|</span>
                                                            <sapn class="ml-1 regular3--text body2">@T("AppCount"):@apps.Count</sapn>
                                                        </div>
                                                    </div>
                                                </span>
                                            </ChildContent>
                                            <ActionsContent>
                                                <MIcon Color="#485585">
                                                    mdi-chevron-down
                                                </MIcon>
                                            </ActionsContent>
                                        </MExpansionPanelHeader>
                                        <MExpansionPanelContent>
                                            <MRow>
                                                @foreach (var app in apps.Where(app => app.IsPinned).Take(3))
                                                {
                                                    <MCol Lg="4" Md="6" Sm="12">
                                                        <AppCard OnClick="()=>NavigateToConfigAsync(new NavigateToConfigModel(app.Id, app.ProjectId, app.EnvironmentClusters[0].Id, ConfigObjectType.App))" OnPinClick="()=>AppPinAsync(app)" IsPin="app.IsPinned" App="app" EnvironmentClusters="app.EnvironmentClusters">
                                                            <MChipGroup Class="env-cluster-chip-group" ActiveClass="primary--text">
                                                                @foreach (var item in app.EnvironmentClusters)
                                                                {
                                                                    <EnvClusterChip OnClick="()=>NavigateToConfigAsync(new NavigateToConfigModel(app.Id, app.ProjectId, item.Id, ConfigObjectType.App))"
                                                                        Style="margin:0 12px 1px 0;"
                                                                        EnvironmentName="@item.EnvironmentName"
                                                                        EnvironmentColor="@item.EnvironmentColor"
                                                                        ClusterName="@item.ClusterName" />
                                                                }
                                                            </MChipGroup>
                                                        </AppCard>
                                                    </MCol>
                                                }
                                            </MRow>
                                            <div class="d-flex justify-end align-flex-end mt-3 mb-2">
                                                <MHover>
                                                    @{
                                                        var mClass = $"{(context.Hover ? "primary--text" : "regular2--text")}";
                                                        <div @onclick="()=>NavigateToAppAsync(project.Id)" @attributes="context.Attrs" class="@($"hover-pointer btn {mClass}")">
                                                            @T("More")
                                                            <MIcon Class="@($"ml-1 {mClass}")" Size="18">mdi-chevron-right</MIcon>
                                                        </div>
                                                    }
                                                </MHover>
                                            </div>
                                        </MExpansionPanelContent>
                                    </MExpansionPanel>
                                }

                            </MExpansionPanels>
                        </div>
                    </div>
                </div>

                <MNavigationDrawer Right Permanent Class="rounded-4" Width="300" Style="height: calc(100vh - 192px);">
                    <div class="py-4 px-6" style="min-width:300px; display:flex; flex-direction:column; overflow: auto;">
                        <MAvatar>
                            <MImage Height="48" Width="48" Src="@_userTeam.Avatar"></MImage>
                        </MAvatar>
                        <MRow NoGutters Class="mt-6">
                            <div class="emphasis--text h6">@_userTeam.Name</div>
                        </MRow>
                        <MRow NoGutters Class="mt-1 regular--text body2">
                            @T("ProjectCount")：
                            <span class="subtitle2">@_projects.Count</span>
                        </MRow>
                        <MRow NoGutters Class="mt-4 regular--text body2">
                            @_userTeam.Description
                        </MRow>
                        <MRow NoGutters Class="regular3--text btn mt-6">@T("Admin")</MRow>
                        @foreach (var item in _userTeam.Admins)
                        {
                            <MRow Align="AlignTypes.Center" NoGutters Class="mt-4 regular--text body2">
                                <MAvatar Class="mr-3">
                                    <MImage Height="48" Width="48" Src="@item.Avatar"></MImage>
                                </MAvatar>
                                @item.Name
                            </MRow>
                        }
                        <MRow NoGutters Class="regular3--text btn mt-6">@T("Members")</MRow>
                        @foreach (var item in _userTeam.Members)
                        {
                            <MRow Align="AlignTypes.Center" NoGutters Class="mt-4 regular--text body2">
                                <MAvatar MinHeight="40" MinWidth="40" Height="40" Width="40" Class="mr-3">
                                    <MImage Height="40" Width="40" Src="@item.Avatar"></MImage>
                                </MAvatar>
                                @item.Name
                            </MRow>
                        }
                    </div>
                </MNavigationDrawer>
            </div>
        </MTabItem>
        <MTabItem>
            <Masa.Dcc.Web.Admin.Rcl.Pages.App ProjectId="_appModel.ProjectId"
                                              AppCount="_appModel.AppCount"
                                              @ref="_app">
            </Masa.Dcc.Web.Admin.Rcl.Pages.App>
        </MTabItem>
        <MTabItem>
            <Config AppId="@_configModel.AppId"
                    ConfigObjectType="@_configModel.ConfigObjectType"
                    EnvironmentClusterId="@_configModel.EnvironmentClusterId"
                    ProjectId="@_configModel.ProjectId"
                    ProjectIdentity="@_configModel.ProjectIdentity"
                    @ref="_config">
            </Config>
        </MTabItem>
    </MTabsItems>
</CascadingValue>